from scapy.all import sniff
import csv
import time
import pandas as pd
import matplotlib
matplotlib.use('TkAgg')  # MacOSâ€™ta grafik penceresi aÃ§Ä±lmazsa diye eklendim
import matplotlib.pyplot as plt
import statistics
from collections import defaultdict

packet_count = 0
packet_sizes = []

# Zaman bazlÄ± IP izleme iÃ§in
ip_zaman_listesi = defaultdict(list)
uyarilmis_ipler = set()
ZAMAN_ESIGI = 5       # saniye
PAKET_ESIGI = 10      # 10'dan fazla istek

# CSV baÅŸlat
with open("trafik_log.csv", mode='w', newline='') as file:
    writer = csv.writer(file)
    writer.writerow([
        "Timestamp", "IP Source", "IP Destination",
        "Source Port", "Destination Port", "Protocol",
        "Packet Size", "Etiket", "AÅŸÄ±rÄ± Ä°stek Yapan IP"
    ])

# Ortalama ve sapma baÅŸta boÅŸ
ortalama = None
sapma = None

def Ã¶rnekle(paket):
    if paket.haslayer('IP') and paket.haslayer('TCP'):
        boyut = len(paket)
        packet_sizes.append(boyut)

print("ğŸŸ¡ Ortalama ve sapma belirleniyor...")
sniff(filter="tcp", prn=Ã¶rnekle, store=0)

ortalama = statistics.mean(packet_sizes)
sapma = statistics.stdev(packet_sizes)
alt_sÄ±nÄ±r = ortalama - 1.5 * sapma
Ã¼st_sÄ±nÄ±r = ortalama + 1.5 * sapma

print(f" Ortalama: {ortalama:.2f} | Std Sapma: {sapma:.2f}")
print(f" Normal AralÄ±k: {alt_sÄ±nÄ±r:.2f} - {Ã¼st_sÄ±nÄ±r:.2f}")

def karar_ver(boyut):
    if boyut < alt_sÄ±nÄ±r or boyut > Ã¼st_sÄ±nÄ±r:
        return "Anormal"
    return "Normal"

def yakala(paket):
    global packet_count
    if paket.haslayer('IP') and paket.haslayer('TCP'):
        packet_count += 1
        timestamp = time.strftime('%Y-%m-%d %H:%M:%S', time.gmtime())
        src_ip = paket['IP'].src
        dst_ip = paket['IP'].dst
        sport = paket['TCP'].sport
        dport = paket['TCP'].dport
        protokol = "TCP"
        boyut = len(paket)
        etiket = karar_ver(boyut)

        # 5 saniyede 10'dan fazla istek kontrolÃ¼
        ÅŸimdi = time.time()
        ip_zaman_listesi[src_ip].append(ÅŸimdi)
        ip_zaman_listesi[src_ip] = [t for t in ip_zaman_listesi[src_ip] if ÅŸimdi - t <= ZAMAN_ESIGI]

        if len(ip_zaman_listesi[src_ip]) > PAKET_ESIGI and src_ip not in uyarilmis_ipler:
            print(f"\nâš ï¸ {ZAMAN_ESIGI} sn iÃ§inde {PAKET_ESIGI}+ istek gÃ¶nderen IP: {src_ip}")
            uyarilmis_ipler.add(src_ip)

        asiri_ip_flag = "TRUE" if src_ip in uyarilmis_ipler else "FALSE"

        # her Ã§Ä±ktÄ±yÄ± yeni satÄ±ra yaz
        if asiri_ip_flag == "TRUE":
            print(f"âš ï¸ {src_ip} â†’ {dst_ip} | Boyut: {boyut} | Etiket: {etiket} | AÅŸÄ±rÄ± Ä°stek Yapan IP | Toplam: {packet_count}")
        else:
            print(f"{src_ip} â†’ {dst_ip} | Boyut: {boyut} | Etiket: {etiket} | Toplam: {packet_count}")

        with open("trafik_log.csv", mode='a', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([
                timestamp, src_ip, dst_ip, sport, dport,
                protokol, boyut, etiket, asiri_ip_flag
            ])

# BaÅŸlat
print("\nğŸŸ¢ Dinleme baÅŸladÄ±. Ctrl+C ile durdurabilirsiniz.")
try:
    sniff(filter="tcp", prn=yakala, store=0)
except KeyboardInterrupt:
    print("\nâ›” Dinleme durduruldu. Analiz baÅŸlatÄ±lÄ±yor...")

df = pd.read_csv("trafik_log.csv")
print("\n\nğŸ“„ Ä°lk 5 veri:\n", df.head())

if 'Packet Size' in df.columns and not df['Packet Size'].empty:
    df['Packet Size'].plot(kind='hist', bins=50, alpha=0.75)
    plt.title('Packet Size Distribution')
    plt.xlabel('Packet Size (bytes)')
    plt.ylabel('Frequency')
    plt.grid(True)
    plt.show()
else:
    print("âš ï¸ 'Packet Size' sÃ¼tunu bulunamadÄ± veya veri yok.")

print("\nğŸ“Š Ä°statistiksel Analiz")

print(f"\nâ€¢ Toplam Yakalanan Paket: {len(df)}")

if 'Protocol' in df.columns:
    print("\nâ€¢ Protokol DaÄŸÄ±lÄ±mÄ±:")
    print(df['Protocol'].value_counts(normalize=True).map(lambda x: f"%{round(x*100, 2)}"))
else:
    print("âš ï¸ 'Protocol' sÃ¼tunu bulunamadÄ±.")

if 'Packet Size' in df.columns:
    print(f"\nâ€¢ Ortalama Paket Boyutu: {round(df['Packet Size'].mean(), 2)} byte")
    print(f"â€¢ En BÃ¼yÃ¼k Paket: {df['Packet Size'].max()} byte")
    print(f"â€¢ En KÃ¼Ã§Ã¼k Paket: {df['Packet Size'].min()} byte")
    print("\nâ€¢ Protokole GÃ¶re Ortalama Paket Boyutu:")
    print(df.groupby("Protocol")["Packet Size"].mean().round(2))
else:
    print("'Packet Size' sÃ¼tunu bulunamadÄ±.")
